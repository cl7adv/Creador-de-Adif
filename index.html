<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poster Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;700;900&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Área de Trabajo */
        .workspace {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            height: 100vh;
        }

        /* El Lienzo del Póster */
        #posterCanvas {
            width: 450px;
            height: 650px;
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            color: #1a1a1a;
            user-select: none;
        }

        .draggable {
            position: absolute;
            cursor: move;
            transition: outline 0.1s;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .draggable:hover {
            outline: 2px dashed #3b82f6;
        }
        .draggable.active {
            outline: 2px solid #3b82f6;
            z-index: 100;
        }

        .logo-element img {
            width: 100%;
            height: auto;
            pointer-events: none;
        }

        #bgImage {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            z-index: 0;
        }

        .tool-panel {
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .edit-panel {
            background: #1e293b;
            border-left: 1px solid #334155;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* Estilos de Texto */
        .style-elegant { font-family: 'Playfair Display', serif; text-transform: none; }
        .style-funny { font-family: 'Bangers', cursive; text-transform: uppercase; letter-spacing: 1px; }
        .style-bold { font-family: 'Inter', sans-serif; font-weight: 900; text-transform: uppercase; }

        input, select, textarea {
            background: #0f172a !important;
            border: 1px solid #334155 !important;
            color: white !important;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 100%;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        .btn-secondary {
            background: #334155;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
        }

        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="font-bold">PROCESANDO DISEÑO...</p>
        </div>
    </div>

    <div class="workspace">
        
        <!-- PANEL IZQUIERDO -->
        <aside class="tool-panel space-y-6">
            <div>
                <h2 class="text-xl font-black mb-1 italic">POSTER DESIGNER PRO</h2>
                <p class="text-[10px] text-slate-400 uppercase tracking-[0.2em] mb-6">Estudio de Creación Visual</p>
            </div>

            <div class="space-y-4">
                <label class="block text-xs font-bold text-slate-500 uppercase">1. Configuración IA</label>
                <input type="password" id="apiKey" placeholder="API Key de Gemini">
            </div>

            <div class="space-y-4">
                <label class="block text-xs font-bold text-slate-500 uppercase">2. Fondo del Póster</label>
                <div class="border-2 border-dashed border-slate-700 rounded-xl p-4 text-center hover:border-blue-500 transition-colors relative">
                    <input type="file" id="imageInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                    <p class="text-xs text-slate-400">Cambiar Foto de Fondo</p>
                </div>
            </div>

            <div class="space-y-4">
                <label class="block text-xs font-bold text-slate-500 uppercase">3. Logos y Elementos</label>
                <div class="grid grid-cols-1 gap-2">
                    <div class="relative">
                        <input type="file" id="logoInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                        <button class="btn-secondary w-full flex items-center justify-center gap-2">
                            <span>+ Subir Logo</span>
                        </button>
                    </div>
                    <button id="addCommentBtn" class="btn-secondary flex items-center justify-center gap-2">
                        <span>+ Agregar Comentario</span>
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <label class="block text-xs font-bold text-slate-500 uppercase">4. ¿Qué anuncias?</label>
                <textarea id="promptInput" rows="3" placeholder="Describe tu actividad para que la IA cree el contenido..."></textarea>
            </div>

            <button id="magicBtn" class="btn-primary w-full mt-4">GENERAR CONTENIDO IA</button>
        </aside>

        <!-- ÁREA CENTRAL -->
        <main class="flex flex-col items-center justify-center bg-slate-900 p-8 overflow-hidden">
            <div id="posterCanvas">
                <img id="bgImage" src="https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&q=80&w=1000" alt="background">
                
                <div id="elTitle" class="draggable active style-elegant text-4xl font-bold" style="top: 50px; left: 50px; width: 350px;">
                    TÍTULO PRINCIPAL
                </div>

                <div id="elDesc" class="draggable style-elegant text-sm text-center" style="top: 450px; left: 50px; width: 350px;">
                    Descripción del anuncio editable y movible.
                </div>

                <div id="elDetails" class="draggable font-bold text-xs bg-black text-white px-3 py-1 uppercase" style="top: 580px; left: 50px;">
                    DETALLES DEL EVENTO
                </div>
            </div>
        </main>

        <!-- PANEL DERECHO -->
        <aside class="edit-panel space-y-6">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Ajustes de Capa</h3>
            
            <div id="editorControls" class="space-y-4">
                <!-- Editor de Texto -->
                <div id="textControls" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Contenido del Texto</label>
                        <textarea id="textEdit" rows="3"></textarea>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Tamaño</label>
                        <input type="range" id="sizeEdit" min="10" max="150" value="40">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Color</label>
                        <input type="color" id="colorEdit" class="h-10">
                    </div>
                </div>

                <!-- Editor de Logo (Se muestra cuando se selecciona un logo) -->
                <div id="logoControls" class="space-y-4 hidden">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Ancho del Logo</label>
                        <input type="range" id="logoSizeEdit" min="20" max="400" value="100">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Fondo de Capa (Opacidad)</label>
                    <input type="range" id="bgOpacityEdit" min="0" max="100" value="0">
                </div>

                <div class="pt-4">
                    <button id="deleteElementBtn" class="w-full p-2 bg-red-900/50 hover:bg-red-600 rounded text-[10px] font-bold uppercase transition-colors">Eliminar Capa Seleccionada</button>
                </div>
            </div>

            <div class="pt-6 border-t border-slate-700 space-y-3">
                <button id="downloadJpg" class="w-full p-3 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold uppercase">Exportar como JPG</button>
                <button onclick="window.print()" class="w-full p-3 bg-slate-700 hover:bg-slate-600 rounded text-xs font-bold uppercase">Imprimir PDF</button>
            </div>
        </aside>

    </div>

    <script type="module">
        let activeElement = document.getElementById('elTitle');
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        const apiKeyInput = document.getElementById('apiKey');
        const imageInput = document.getElementById('imageInput');
        const logoInput = document.getElementById('logoInput');
        const addCommentBtn = document.getElementById('addCommentBtn');
        const bgImage = document.getElementById('bgImage');
        const magicBtn = document.getElementById('magicBtn');
        const loading = document.getElementById('loadingOverlay');
        const posterCanvas = document.getElementById('posterCanvas');
        const downloadJpg = document.getElementById('downloadJpg');

        // Función para asignar eventos de arrastre a nuevos elementos
        function makeDraggable(el) {
            el.addEventListener('mousedown', (e) => {
                activeElement = el;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                
                updateEditorUI();
                
                document.querySelectorAll('.draggable').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
            });
        }

        function updateEditorUI() {
            const isLogo = activeElement.classList.contains('logo-element');
            document.getElementById('textControls').classList.toggle('hidden', isLogo);
            document.getElementById('logoControls').classList.toggle('hidden', !isLogo);

            if (!isLogo) {
                document.getElementById('textEdit').value = activeElement.innerText;
                document.getElementById('sizeEdit').value = parseInt(window.getComputedStyle(activeElement).fontSize);
                document.getElementById('colorEdit').value = rgbToHex(window.getComputedStyle(activeElement).color);
            } else {
                document.getElementById('logoSizeEdit').value = activeElement.offsetWidth;
            }
            
            const bg = window.getComputedStyle(activeElement).backgroundColor;
            const alpha = bg.match(/rgba?\(.+,\s*([\d.]+)\)/);
            document.getElementById('bgOpacityEdit').value = alpha ? parseFloat(alpha[1]) * 100 : 0;
        }

        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            return result ? "#" + result.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('') : "#000000";
        }

        // Mouse Events Globales
        document.addEventListener('mousemove', (e) => {
            if (!isDragging || !activeElement) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            activeElement.style.left = `${initialLeft + dx}px`;
            activeElement.style.top = `${initialTop + dy}px`;
        });

        document.addEventListener('mouseup', () => isDragging = false);

        // Inicializar elementos existentes
        document.querySelectorAll('.draggable').forEach(makeDraggable);

        // Subir Logos
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const div = document.createElement('div');
                    div.className = 'draggable logo-element';
                    div.style.width = '100px';
                    div.style.top = '100px';
                    div.style.left = '100px';
                    div.innerHTML = `<img src="${ev.target.result}" alt="logo">`;
                    posterCanvas.appendChild(div);
                    makeDraggable(div);
                };
                reader.readAsDataURL(file);
            }
        });

        // Agregar Comentarios
        addCommentBtn.addEventListener('click', () => {
            const div = document.createElement('div');
            div.className = 'draggable style-bold text-sm';
            div.style.top = '200px';
            div.style.left = '100px';
            div.style.width = '200px';
            div.innerText = 'Nuevo comentario...';
            posterCanvas.appendChild(div);
            makeDraggable(div);
        });

        // Eliminar Elementos
        document.getElementById('deleteElementBtn').addEventListener('click', () => {
            if (activeElement && !['elTitle', 'elDesc', 'elDetails'].includes(activeElement.id)) {
                activeElement.remove();
                activeElement = null;
            } else if (activeElement) {
                alert("Este elemento principal no se puede borrar, solo editar.");
            }
        });

        // Controles Live
        document.getElementById('textEdit').addEventListener('input', (e) => {
            if (activeElement && !activeElement.classList.contains('logo-element')) {
                activeElement.innerText = e.target.value;
            }
        });

        document.getElementById('sizeEdit').addEventListener('input', (e) => {
            if (activeElement && !activeElement.classList.contains('logo-element')) {
                activeElement.style.fontSize = `${e.target.value}px`;
            }
        });

        document.getElementById('logoSizeEdit').addEventListener('input', (e) => {
            if (activeElement && activeElement.classList.contains('logo-element')) {
                activeElement.style.width = `${e.target.value}px`;
            }
        });

        document.getElementById('colorEdit').addEventListener('input', (e) => {
            if (activeElement) activeElement.style.color = e.target.value;
        });

        document.getElementById('bgOpacityEdit').addEventListener('input', (e) => {
            if (activeElement) activeElement.style.backgroundColor = `rgba(0,0,0,${e.target.value/100})`;
        });

        // Exportar JPG
        downloadJpg.addEventListener('click', () => {
            loading.style.display = 'flex';
            // Quitar el borde de selección antes de la captura
            document.querySelectorAll('.draggable').forEach(d => d.classList.remove('active'));
            
            html2canvas(posterCanvas, {
                useCORS: true,
                scale: 2 // Alta calidad
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'mi-poster-pro.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                loading.style.display = 'none';
            });
        });

        // IA Integration
        async function fetchGemini(prompt, base64) {
            const key = apiKeyInput.value.trim();
            if (!key) throw new Error("API Key requerida");
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            
            const parts = [{ text: prompt }];
            if (base64) parts.push({ inlineData: { mimeType: "image/png", data: base64 } });

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                headline: { type: "string" },
                                body: { type: "string" },
                                footer: { type: "string" },
                                color: { type: "string" }
                            }
                        }
                    }
                })
            });

            const data = await response.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        magicBtn.addEventListener('click', async () => {
            const key = apiKeyInput.value.trim();
            const userPrompt = document.getElementById('promptInput').value;
            if (!key) return alert("Pega tu API Key de Gemini");

            loading.style.display = 'flex';
            
            try {
                let base64 = null;
                if (imageInput.files[0]) {
                    const reader = new FileReader();
                    base64 = await new Promise(resolve => {
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(imageInput.files[0]);
                    });
                }

                const aiPrompt = `Eres un director creativo. Crea contenido publicitario profesional basado en: "${userPrompt}". 
                Analiza la imagen si existe. El headline (título) debe ser impactante. El body una invitación cautivadora. El footer los detalles técnicos. 
                Sugiere un color hexadecimal para el texto que sea legible y elegante sobre el fondo.`;

                const result = await fetchGemini(aiPrompt, base64);

                document.getElementById('elTitle').innerText = result.headline;
                document.getElementById('elDesc').innerText = result.body;
                document.getElementById('elDetails').innerText = result.footer;
                
                document.querySelectorAll('.draggable:not(.logo-element)').forEach(el => {
                    el.style.color = result.color;
                });

            } catch (err) {
                alert("Error de IA: " + err.message);
            } finally {
                loading.style.display = 'none';
            }
        });

        // Carga de Fondo
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => bgImage.src = ev.target.result;
                reader.readAsDataURL(file);
            }
        });

        // Initialize
        if(localStorage.getItem('gemini_free_key')) apiKeyInput.value = localStorage.getItem('gemini_free_key');
    </script>
</body>
</html>
