<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CM6OM: AI Voice Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bg-psycho {
            0% { background-color: #0f172a; }
            50% { background-color: #312e81; }
            100% { background-color: #0f172a; }
        }

        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            touch-action: none;
            animation: bg-psycho 10s infinite alternate;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        .character {
            position: absolute;
            transition: left 0.4s ease-out, top 0.4s ease-out;
            z-index: 10;
        }

        .face-cm6om {
            width: 45px;
            height: 90px;
            background: linear-gradient(180deg, #fbbf24 0%, #d97706 70%, #451a03 100%);
            border-radius: 20px 20px 35px 35px;
            border: 2px solid #000;
            position: relative;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .eye-evil {
            width: 10px;
            height: 6px;
            background: #ff0000;
            border-radius: 50%;
            box-shadow: 0 0 8px red;
        }

        .beard-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40px;
            background-color: #271302;
            background-image: radial-gradient(#000 10%, transparent 10%);
            background-size: 3px 3px;
            border-radius: 0 0 35px 35px;
        }

        .face-normal {
            width: 40px;
            height: 40px;
            background: #38bdf8;
            border-radius: 50%;
            border: 2px solid #0369a1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scanner-overlay {
            position: absolute;
            pointer-events: none;
            border: 4px dashed #ec4899;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            background: rgba(236, 72, 153, 0.15);
            box-shadow: 0 0 30px #ec4899;
            z-index: 50;
            display: none;
        }

        .message-box {
            position: fixed;
            inset: 20px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 1.5rem;
            border: 3px solid #ec4899;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 1000;
            padding: 20px;
        }

        #epic-final-overlay {
            position: fixed;
            inset: 0;
            background: black;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
    </style>
</head>
<body>

<div id="main-ui" class="h-[80px] p-2 flex justify-between items-center bg-slate-900 border-b-2 border-pink-500">
    <div class="leading-tight">
        <h1 class="text-lg font-black text-yellow-400 italic">CM6OM GEMINI VOICE</h1>
        <p class="text-[10px] text-pink-400 font-bold uppercase tracking-widest">Voz de API Integrada</p>
    </div>
    <div class="text-right">
        <div class="text-xl font-mono text-white">RADIOS: <span id="score">0</span></div>
        <div class="text-xs text-green-400 uppercase font-bold">NIVEL: <span id="level">1</span></div>
    </div>
</div>

<div class="game-container" id="gameCanvas">
    <div id="scanner-overlay"></div>
</div>

<div id="startScreen" class="message-box">
    <div id="intro-face" class="mb-6 scale-110"></div>
    <h2 class="text-3xl font-black mb-2 text-white italic">CONEXIÃ“N NEURONAL</h2>
    <p class="mb-6 text-sm text-yellow-300">CM6OM ahora usa mi propia voz.<br>Si no oyes nada, sube el volumen.</p>
    <button onclick="startGame()" class="bg-pink-600 active:bg-yellow-500 text-white font-black py-4 px-10 rounded-xl uppercase tracking-widest shadow-lg">
        Â¡ACTIVAR AUDIO!
    </button>
</div>

<div id="epic-final-overlay">
    <div id="final-character" class="scale-150 mb-12"></div>
    <h2 class="text-4xl font-black text-white italic text-center px-4" id="final-msg">
        WILBER VOY HACIA TIIIIII!!!!!!!
    </h2>
    <p class="mt-8 text-xl text-yellow-400">Puntaje: <span id="finalScore">0</span></p>
    <button onclick="location.reload()" class="mt-10 bg-white text-black font-black py-3 px-8 rounded-full">REINTENTAR</button>
</div>

<div class="fixed bottom-4 left-0 right-0 text-center pointer-events-none">
    <div class="inline-block bg-pink-600 px-4 py-1 rounded-full border border-white text-sm">
        TIEMPO: <span id="timer" class="font-mono font-bold">30</span>s
    </div>
</div>

<script>
    const apiKey = ""; // API Key gestionada por el entorno
    const canvas = document.getElementById('gameCanvas');
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const timerEl = document.getElementById('timer');
    const scanner = document.getElementById('scanner-overlay');
    
    let score = 0, level = 1, timeLeft = 30, gameActive = false;
    let timerInterval, cm6omInterval;
    let audioCtx = null;
    let systemVoices = [];

    // Inicializar lista de voces para fallback
    window.speechSynthesis.onvoiceschanged = () => {
        systemVoices = window.speechSynthesis.getVoices();
    };

    // FunciÃ³n para convertir PCM16 a WAV (requerido para la API TTS)
    function pcmToWav(pcmData, sampleRate) {
        const buffer = new ArrayBuffer(44 + pcmData.length * 2);
        const view = new DataView(buffer);
        const writeString = (offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        writeString(0, 'RIFF');
        view.setUint32(4, 32 + pcmData.length * 2, true);
        writeString(8, 'WAVE');
        writeString(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        writeString(36, 'data');
        view.setUint32(40, pcmData.length * 2, true);

        let offset = 44;
        for (let i = 0; i < pcmData.length; i++, offset += 2) {
            view.setInt16(offset, pcmData[i], true);
        }
        return buffer;
    }

    // Fallback Offline si la API falla
    function speakOffline(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const voice = systemVoices.find(v => v.lang.includes('es') && v.name.includes('Male')) || systemVoices.find(v => v.lang.includes('es'));
        if (voice) utterance.voice = voice;
        utterance.pitch = 0.1;
        utterance.rate = 0.6;
        window.speechSynthesis.speak(utterance);
    }

    // FunciÃ³n para llamar a la API de Voz de Gemini
    async function speakWithGemini(text) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Say in a very deep, terrifying, slow, demonic villain voice: ${text}` }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Fenrir" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                })
            });

            const result = await response.json();
            const audioBase64 = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            
            if (audioBase64) {
                const binaryString = atob(audioBase64);
                const len = binaryString.length;
                const bytes = new Int16Array(len / 2);
                for (let i = 0; i < len; i += 2) {
                    bytes[i / 2] = (binaryString.charCodeAt(i+1) << 8) | binaryString.charCodeAt(i);
                }

                const wavBuffer = pcmToWav(bytes, 24000);
                const audioBuffer = await audioCtx.decodeAudioData(wavBuffer);
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                
                const filter = audioCtx.createBiquadFilter();
                filter.type = "lowshelf";
                filter.frequency.value = 200;
                filter.gain.value = 20; // MÃ¡s potencia de bajos

                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 1.5; // Subir volumen general

                source.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                source.start();
            } else {
                speakOffline(text);
            }
        } catch (error) {
            console.error("Error de API, usando fallback offline", error);
            speakOffline(text);
        }

        if (navigator.vibrate) navigator.vibrate([150, 50, 150]);
    }

    canvas.addEventListener('touchstart', async (e) => {
        if (!gameActive) return;
        if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX;
        const y = touch.clientY;

        scanner.style.display = 'block';
        scanner.style.left = x + 'px';
        scanner.style.top = (y - rect.top) + 'px';

        checkCapture(x, y);
    });

    function checkCapture(x, y) {
        const target = document.querySelector('.character-target');
        if (!target) return;
        
        const rect = target.getBoundingClientRect();
        const tx = rect.left + rect.width / 2;
        const ty = rect.top + rect.height / 2;
        const dist = Math.sqrt(Math.pow(x - tx, 2) + Math.pow(y - ty, 2));

        if (dist < 60) {
            handleSuccess();
        } else {
            handleMiss();
        }
    }

    function handleSuccess() {
        score++; level++; timeLeft += 5;
        scoreEl.textContent = score; levelEl.textContent = level;
        spawnCharacters();
    }

    function handleMiss() {
        timeLeft -= 3;
        const phrases = ["Wilber", "Es mÃ­o", "RÃ­ndete"];
        speakWithGemini(phrases[Math.floor(Math.random() * phrases.length)]);
    }

    function createVillainFace() {
        return `<div class="face-cm6om">
            <div class="flex justify-around mt-4"><div class="eye-evil"></div><div class="eye-evil"></div></div>
            <div class="beard-area"></div>
            <div class="absolute -top-6 left-2 text-xl">ðŸ“»</div>
        </div>`;
    }

    function createScaredFace() {
        return `<div class="face-normal"><div class="text-[10px]">ðŸ˜°</div></div>`;
    }

    function spawnCharacters() {
        canvas.querySelectorAll('.character').forEach(c => c.remove());
        clearInterval(cm6omInterval);
        
        const count = Math.min(8 + level, 25);
        const targetIdx = Math.floor(Math.random() * count);

        for (let i = 0; i < count; i++) {
            const char = document.createElement('div');
            const isTarget = i === targetIdx;
            char.className = 'character' + (isTarget ? ' character-target' : '');
            char.innerHTML = isTarget ? createVillainFace() : createScaredFace();
            
            char.style.left = Math.random() * (window.innerWidth - 50) + 'px';
            char.style.top = Math.random() * (canvas.offsetHeight - 90) + 'px';
            canvas.appendChild(char);

            if (isTarget) {
                cm6omInterval = setInterval(() => {
                    if (!gameActive) return;
                    char.style.left = Math.random() * (window.innerWidth - 50) + 'px';
                    char.style.top = Math.random() * (canvas.offsetHeight - 90) + 'px';
                }, Math.max(300, 1000 - (level * 70)));
            }
        }
    }

    async function startGame() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
        score = 0; level = 1; timeLeft = 30; gameActive = true;
        document.getElementById('startScreen').style.display = 'none';
        spawnCharacters();
        timerInterval = setInterval(() => {
            timeLeft--;
            timerEl.textContent = timeLeft;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function endGame() {
        gameActive = false;
        clearInterval(timerInterval);
        clearInterval(cm6omInterval);
        document.getElementById('epic-final-overlay').style.display = 'flex';
        document.getElementById('final-character').innerHTML = createVillainFace();
        document.getElementById('finalScore').textContent = score;
        
        setTimeout(() => {
            speakWithGemini("Wilber voy hacia ti");
        }, 500);
    }

    document.getElementById('intro-face').innerHTML = createVillainFace();
</script>
</body>
</html>
